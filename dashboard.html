<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: http: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:; style-src 'self' 'unsafe-inline' https: http:; font-src 'self' https: http: data:; img-src 'self' https: http: data: blob:; connect-src 'self' https: http: ws: wss: http://localhost:8001 http://localhost:8000;">
    <title>ë¹—ì¸ ìë™ë§¤ë§¤ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .table-dark { background-color: #343a40; }
        .status-active { color: #28a745; }
        .status-pending { color: #ffc107; }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                ë¹—ì¸ ìë™ë§¤ë§¤ ëŒ€ì‹œë³´ë“œ
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <span class="badge bg-success">ğŸ”¥ ì‹¤ê±°ë˜ ë°ì´í„°</span>
                </span>
                <span class="navbar-text" id="currentTime"></span>
            </div>
        </div>
    </nav>

    <!-- ì‹¤ê±°ë˜ ë°ì´í„° ì•Œë¦¼ ë°°ë„ˆ -->
    <div class="container mt-2">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>ì‹¤ê±°ë˜ ë°ì´í„° ì—°ë™ ì™„ë£Œ!</strong>
            í˜„ì¬ ë¹—ì¸ ì‹¤ì œ APIì—ì„œ ì‹œì„¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.
            BTC í˜„ì¬ê°€: <span id="liveBtcPrice">ë¡œë”©ì¤‘...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <div class="container mt-4">
        <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œë“¤ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value" id="totalBalance">â‚©0</div>
                        <div class="metric-label">ì´ ìì‚°</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value" id="dailyPnl">â‚©0</div>
                        <div class="metric-label">ì¼ì¼ ì†ìµ</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value" id="successRate">0%</div>
                        <div class="metric-label">ìŠ¹ë¥ </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value" id="activePositions">0</div>
                        <div class="metric-label">ë³´ìœ  í¬ì§€ì…˜</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- í¬ì§€ì…˜ ì •ë³´ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-wallet me-2"></i>
                            í˜„ì¬ í¬ì§€ì…˜
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ì¢…ëª©</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>í˜„ì¬ê°€</th>
                                        <th>ì†ìµ</th>
                                        <th>ìˆ˜ìµë¥ </th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ê±°ë˜ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>
                            ìµœê·¼ ê±°ë˜
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ì‹œê°„</th>
                                        <th>ì¢…ëª©</th>
                                        <th>ìœ í˜•</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>ê°€ê²©</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìë™ë§¤ë§¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            ìë™ë§¤ë§¤ ì—”ì§„ ìƒíƒœ
                            <span class="badge bg-warning ms-2" id="tradingStatus">STOPPED</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>ì—”ì§„ ì •ë³´</h6>
                                <p class="mb-1">ì „ëµ: <strong>EMA + RSI + ATR</strong></p>
                                <p class="mb-1">ëŒ€ìƒ: <strong>BTC, ETH, XRP</strong></p>
                                <p class="mb-1">í¬ì§€ì…˜ í¬ê¸°: <strong>1%</strong></p>
                                <p class="mb-0">ìµœëŒ€ ì£¼ë¬¸: <strong>â‚©50,000</strong></p>
                            </div>
                            <div class="col-md-4">
                                <h6>ì‹¤ì‹œê°„ ì‹ í˜¸ ë¶„ì„</h6>
                                <div id="tradingSignals">
                                    <p class="text-muted">ì‹ í˜¸ ë¶„ì„ ì¤‘...</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>ë§¤ë§¤ ì„±ê³¼</h6>
                                <p class="mb-1">ì˜¤ëŠ˜ ê±°ë˜: <strong id="dailyTrades">0</strong>íšŒ</p>
                                <p class="mb-1">ì„±ê³µë¥ : <strong id="tradingWinRate">0%</strong></p>
                                <p class="mb-0">ìˆ˜ìµ/ì†ì‹¤: <strong id="tradingPnL">â‚©0</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„±ê³¼ ì°¨íŠ¸ -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            ìì‚° ê³¡ì„ 
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="equityChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- ì„±ê³¼ ì§€í‘œ -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy me-2"></i>
                            ì„±ê³¼ ì§€í‘œ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>ì´ ìˆ˜ìµë¥ :</span>
                                    <strong id="totalReturn" class="positive">0%</strong>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>ì—°í™˜ì‚° ìˆ˜ìµë¥ :</span>
                                    <strong id="annualizedReturn" class="positive">0%</strong>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>ìµœëŒ€ ë‚™í­:</span>
                                    <strong id="maxDrawdown" class="negative">0%</strong>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>ìƒ¤í”„ ë¹„ìœ¨:</span>
                                    <strong id="sharpeRatio">0</strong>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span>ì´ ê±°ë˜ ìˆ˜:</span>
                                    <strong id="totalTrades">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8001/api';

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ko-KR');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ì‹¤ì‹œê°„ BTC ê°€ê²© ì—…ë°ì´íŠ¸
        async function updateLiveBtcPrice() {
            try {
                const response = await fetch(`${API_BASE}/realtime/ticker/BTC`);
                const data = await response.json();
                const priceElement = document.getElementById('liveBtcPrice');
                if (priceElement) {
                    priceElement.textContent = formatCurrency(data.current_price);
                    priceElement.className = 'fw-bold text-primary';
                }
            } catch (error) {
                console.error('BTC ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                const priceElement = document.getElementById('liveBtcPrice');
                if (priceElement) {
                    priceElement.textContent = 'ì—°ê²° ì˜¤ë¥˜';
                    priceElement.className = 'fw-bold text-danger';
                }
            }
        }

        // 10ì´ˆë§ˆë‹¤ BTC ê°€ê²© ì—…ë°ì´íŠ¸
        setInterval(updateLiveBtcPrice, 10000);
        updateLiveBtcPrice();

        // ìˆ«ì í¬ë§·íŒ…
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        function formatCurrency(amount) {
            return 'â‚©' + formatNumber(Math.round(amount));
        }

        // ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì •ë³´ ë¡œë“œ
        async function loadDashboardSummary() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/summary`);
                const data = await response.json();

                document.getElementById('totalBalance').textContent = formatCurrency(data.total_balance_krw);
                document.getElementById('dailyPnl').textContent = formatCurrency(data.daily_pnl);
                document.getElementById('successRate').textContent = data.success_rate.toFixed(1) + '%';
                document.getElementById('activePositions').textContent = data.active_positions;

                // ì¼ì¼ ì†ìµ ìƒ‰ìƒ ë³€ê²½
                const dailyPnlElement = document.getElementById('dailyPnl');
                dailyPnlElement.classList.remove('positive', 'negative');
                dailyPnlElement.classList.add(data.daily_pnl >= 0 ? 'positive' : 'negative');
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í¬ì§€ì…˜ ì •ë³´ ë¡œë“œ
        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/positions`);
                const positions = await response.json();

                const tbody = document.getElementById('positionsTable');
                tbody.innerHTML = '';

                positions.forEach(position => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${position.symbol}</strong></td>
                        <td>${position.quantity}</td>
                        <td>${formatCurrency(position.current_price)}</td>
                        <td class="${position.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(position.unrealized_pnl)}
                        </td>
                        <td class="${position.unrealized_pnl_percent >= 0 ? 'positive' : 'negative'}">
                            ${position.unrealized_pnl_percent.toFixed(2)}%
                        </td>
                    `;
                });
            } catch (error) {
                console.error('í¬ì§€ì…˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìµœê·¼ ê±°ë˜ ë¡œë“œ
        async function loadRecentTrades() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/recent-trades`);
                const data = await response.json();

                const tbody = document.getElementById('tradesTable');
                tbody.innerHTML = '';

                data.trades.forEach(trade => {
                    const row = tbody.insertRow();
                    const time = new Date(trade.timestamp).toLocaleTimeString('ko-KR');

                    row.innerHTML = `
                        <td>${time}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td>
                            <span class="badge ${trade.side === 'buy' ? 'bg-success' : 'bg-danger'}">
                                ${trade.side.toUpperCase()}
                            </span>
                        </td>
                        <td>${trade.quantity}</td>
                        <td>${formatCurrency(trade.price)}</td>
                    `;
                });
            } catch (error) {
                console.error('ìµœê·¼ ê±°ë˜ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„±ê³¼ ì§€í‘œ ë¡œë“œ
        async function loadPerformanceMetrics() {
            try {
                const response = await fetch(`${API_BASE}/analysis/performance`);
                const metrics = await response.json();

                document.getElementById('totalReturn').textContent = metrics.total_return.toFixed(2) + '%';
                document.getElementById('annualizedReturn').textContent = metrics.annualized_return.toFixed(2) + '%';
                document.getElementById('maxDrawdown').textContent = '-' + metrics.max_drawdown.toFixed(2) + '%';
                document.getElementById('sharpeRatio').textContent = metrics.sharpe_ratio.toFixed(2);
                document.getElementById('totalTrades').textContent = formatNumber(metrics.total_trades);
            } catch (error) {
                console.error('ì„±ê³¼ ì§€í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìë™ë§¤ë§¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        async function loadTradingStatus() {
            try {
                const response = await fetch(`${API_BASE}/trading/status`);
                const data = await response.json();

                const statusElement = document.getElementById('tradingStatus');
                if (data.trading_engine_status === 'running') {
                    statusElement.textContent = 'RUNNING';
                    statusElement.className = 'badge bg-success ms-2';
                } else {
                    statusElement.textContent = 'STOPPED';
                    statusElement.className = 'badge bg-warning ms-2';
                }
            } catch (error) {
                console.error('ìë™ë§¤ë§¤ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
                const statusElement = document.getElementById('tradingStatus');
                statusElement.textContent = 'ERROR';
                statusElement.className = 'badge bg-danger ms-2';
            }
        }

        // ë§¤ë§¤ ì‹ í˜¸ ë¶„ì„ ì—…ë°ì´íŠ¸
        async function loadTradingSignals() {
            try {
                const response = await fetch(`${API_BASE}/trading/signals`);
                const data = await response.json();

                const signalsElement = document.getElementById('tradingSignals');
                if (data.signals && data.signals.length > 0) {
                    let signalsHtml = '';
                    data.signals.forEach(signal => {
                        const actionClass = signal.action === 'BUY' ? 'text-success' :
                                          signal.action === 'SELL' ? 'text-danger' : 'text-muted';
                        signalsHtml += `
                            <p class="mb-1">
                                <strong>${signal.symbol.replace('_KRW', '')}</strong>:
                                <span class="${actionClass}">${signal.action}</span>
                                <small>(${formatCurrency(signal.current_price)})</small>
                            </p>
                        `;
                    });
                    signalsElement.innerHTML = signalsHtml;
                } else {
                    signalsElement.innerHTML = '<p class="text-muted">ì‹ í˜¸ ì—†ìŒ</p>';
                }
            } catch (error) {
                console.error('ë§¤ë§¤ ì‹ í˜¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('tradingSignals').innerHTML = '<p class="text-danger">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // ë§¤ë§¤ ì„±ê³¼ ì—…ë°ì´íŠ¸
        async function loadTradingPerformance() {
            try {
                const response = await fetch(`${API_BASE}/trading/performance`);
                const data = await response.json();

                document.getElementById('dailyTrades').textContent = data.daily_trades || 0;
                document.getElementById('tradingWinRate').textContent = (data.win_rate || 0).toFixed(1) + '%';

                const pnlElement = document.getElementById('tradingPnL');
                const pnl = data.total_profit_loss || 0;
                pnlElement.textContent = formatCurrency(pnl);
                pnlElement.className = pnl >= 0 ? 'positive' : 'negative';
            } catch (error) {
                console.error('ë§¤ë§¤ ì„±ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìì‚° ê³¡ì„  ì°¨íŠ¸
        async function loadEquityCurve() {
            try {
                const response = await fetch(`${API_BASE}/analysis/equity-curve`);
                const data = await response.json();

                const ctx = document.getElementById('equityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.equity_curve.map(point => {
                            const date = new Date(point.date);
                            return `${date.getMonth() + 1}/${date.getDate()}`;
                        }),
                        datasets: [{
                            label: 'ìì‚°',
                            data: data.equity_curve.map(point => point.equity),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '30ì¼ ìì‚° ë³€í™”'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ìì‚° ê³¡ì„  ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ˆê¸° ë¡œë“œ ë° ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
        async function initDashboard() {
            await Promise.all([
                loadDashboardSummary(),
                loadPositions(),
                loadRecentTrades(),
                loadPerformanceMetrics(),
                loadEquityCurve(),
                loadTradingStatus(),
                loadTradingSignals(),
                loadTradingPerformance()
            ]);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initDashboard);

        // 30ì´ˆë§ˆë‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸
        setInterval(() => {
            loadDashboardSummary();
            loadPositions();
            loadRecentTrades();
            loadTradingStatus();
            loadTradingSignals();
            loadTradingPerformance();
        }, 30000);
    </script>
</body>
</html>